<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Level Indicator</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="cap.css" />
	
</head>
<body>
	<div class ="box" style="width: 100%; height: 50px; background-color: #DBDBDB;">

	</div>
	
	<div class ="box" style="width: 100%; height: 50%; background-color: #FFFFFF;">
		<div class="container">
			<div class="water-tank">
				<div class="water-level" id="waterLevel" style="height: 50%;"></div>
			</div>
		</div>
		
		<div id="chartsContainer">		
			<div class="chartBox"><canvas id="myBarChart"></canvas></div>	
		</div>	
			
		<div id="chartsContainer">	
			<div class="chartBox"><canvas id="myLineChart"></canvas></div>
		</div>
		
		<div id="chartsContainer">	
			<div class="chartBox"><canvas id="myDoughnutChart"></canvas></div>
		</div>
		
	</div>
	
	<div class ="box" style="width: 100%; height: 50px; background-color: #FFFFFF;">
		<div class="menu" style="width:20%; height:80%; background-color: #DDDDDD;" > realtime data </div>
		<div class="menu" style="width:20%; height:80%; background-color: #DDDDDD;" > o </div>
		<div class="menu" style="width:20%; height:80%; background-color: #DDDDDD;" > o </div>
		<div class="menu" style="width:20%; height:80%; background-color: #DDDDDD;" > o </div>		
	</div>

	<div class ="box" style="width: 100%; height: 50px; background-color: #FFFFFF;">
		<div class = "menu" > 0 </div>
		<div class = "menu" > 1 </div>
		<div class = "menu" > 2 </div>
		<div class = "menu" > 3 </div>
		<div class = "menu" > 4 </div>
	</div>
	
    <script>
        const pastelColors = {
            backgroundColor: [
                'rgba(255, 179, 186, 0.6)', // Pastel Red
                'rgba(255, 223, 186, 0.6)', // Pastel Orange
                'rgba(255, 255, 186, 0.6)', // Pastel Yellow
                'rgba(186, 255, 201, 0.6)', // Pastel Green
                'rgba(186, 225, 255, 0.6)', // Pastel Blue
                'rgba(223, 186, 255, 0.6)', // Pastel Purple
                'rgba(255, 186, 241, 0.6)'  // Pastel Pink
            ],
            borderColor: [
                'rgba(255, 179, 186, 1)',
                'rgba(255, 223, 186, 1)',
                'rgba(255, 255, 186, 1)',
                'rgba(186, 255, 201, 1)',
                'rgba(186, 225, 255, 1)',
                'rgba(223, 186, 255, 1)',
                'rgba(255, 186, 241, 1)'
            ]
        };

        const chartsConfig = [
            { id: 'myBarChart', type: 'bar', labels: ['1', '2', '3', '4', '5', '6'], data: [0, 0, 0, 0, 0, 0] },
            { id: 'myLineChart', type: 'line', labels: ['1', '2', '3', '4', '5', '6'], data: [0, 0, 0, 0, 0, 0] },
            { id: 'myDoughnutChart', type: 'doughnut', labels: ['1', '2', '3', '4', '5', '6'], data: [0, 0, 0, 0, 0, 0] },
            { id: 'myPieChart', type: 'pie', labels: ['header', 'channel', 'response', 'status', 'cycle_no', 'step'], data: [0, 0, 0, 0, 0, 0] },
            { id: 'myRadarChart', type: 'radar', labels: ['header', 'channel', 'response', 'status', 'cycle_no', 'step'], data: [0, 0, 0, 0, 0, 0] },
            { id: 'myPolarAreaChart', type: 'polarArea', labels: ['header', 'channel', 'response', 'status', 'cycle_no', 'step'], data: [0, 0, 0, 0, 0] },
            { id: 'myScatterChart', type: 'scatter', data: [{ x: 0, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 0 }] }
        ];

        const charts = {};

        chartsConfig.forEach(function(config) 
		{
            const ctx = document.getElementById(config.id).getContext('2d');
            charts[config.id] = new Chart(ctx, {
                type: config.type,
                data: {
                    labels: config.labels,
                    datasets: [{
                        label: 'Dataset',
                        data: config.data,
                        backgroundColor: pastelColors.backgroundColor.slice(0, config.data.length),
                        borderColor: pastelColors.borderColor.slice(0, config.data.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true },
                        x: config.type === 'bubble' || config.type === 'scatter' ? { type: 'linear', position: 'bottom' } : {}
                    }
                }
            });
        });

        var ws = new liteio_WebSocket('192.168.0.173', 8090, 5000, function(msg) 
		{
            console.log("메시지 수신: ", msg);
            updateChartsWithData(msg);
            updateDataList(msg);
        });
        ws.connect();

        function updateChartsWithData(data) 
		{
            var reader = new FileReader();
            reader.onload = function(event) {
                var arrayBuffer = event.target.result;
                var byteArray = new Uint8Array(arrayBuffer);
                var fieldLengths = [2, 2, 2, 2, 2, 2, 2, 2, 2];
                var byteOffset = 0;

                for (var i = 0; i < fieldLengths.length; i++) 
				{
                    var length = fieldLengths[i];
                    var chunk = byteArray.slice(byteOffset, byteOffset + length);
                    var value = parseInt(byteArrayToHexString(chunk).replace(/ /g, ''), 16);
                    byteOffset += length;

                    if (i >= 2 && i <= 5) 
					{
                        var datasetIndex = i - 2;
                        Object.values(charts).forEach(function(chart) {
                            if (chart.config.type === 'bubble' || chart.config.type === 'scatter') 
							{
                                chart.data.datasets[0].data[datasetIndex] = { x: value, y: value, r: value };
                            } 
							else 
							{
                                chart.data.datasets[0].data[datasetIndex] = value;
                            }
                            chart.update();
                        });
                    }
                }
            };
            reader.readAsArrayBuffer(data);
        }

        function updateDataList(data) 
		{
            var reader = new FileReader();
            reader.onload = function(event) 
			{
                var arrayBuffer = event.target.result;
                var byteArray = new Uint8Array(arrayBuffer);
                var value = byteArrayToHexString(byteArray).replace(/ /g, ' ');
                var dataList = document.getElementById('dataList');
                var newItem = document.createElement('li');
                newItem.textContent = value;

                dataList.insertBefore(newItem, dataList.firstChild);

                if (dataList.childElementCount > 10) {
                    dataList.removeChild(dataList.lastChild);
                }
            };
            reader.readAsArrayBuffer(data);
        }

        function byteArrayToHexString(byteArray) 
		{
            return Array.prototype.map.call(byteArray, function(byte) {
                return ('0' + (byte & 0xFF).toString(16)).slice(-2);
            }).join(' ');
        }
	
	
    </script>
</body>
</html>

